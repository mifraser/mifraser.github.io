---
published: true 
layout: post
title:  "A first post using Jekyll and Docker"
date:   2019-03-06
categories: git
---

Creating a first blog post using the default (minima) Jekyll theme running through Docker.

Contents:
* TOC
{:toc}

## Tasks involved

- Running Jekyll through Docker
- Initialising a Jekyll website

## Software used

- GNU Bash
- [Git](https://git-scm.com) version 2.19.1
- [Jekyll](https://jekyllrb.com) version 3.7.4 with ruby 2.6.1p33 (2019-01-30 revision 66950)
- [Docker](https://www.docker.com) version 18.09.3,

## Why Docker?

Jekyll is written in Ruby.
If you don't have Jekyll, Ruby and all relevant dependencies installed then you may consider running Jekyll through Docker instead.

### Install Docker

Install [Docker](https://www.docker.com), for example on Ubuntu Linux by following the instructions for the [Docker Engine Community Edition](https://docs.docker.com/install/linux/docker-ce/ubuntu).

Example command log:

{% highlight shell %}
# Confirm you don't have any old versions of Docker installed (otherwise you 
# may need to remove them)
$ docker
Command 'docker' not found, but can be installed with:
...

$ docker.io
docker.io: command not found

$ docker-engine
docker-engine: command not found

# Good, no old versions to remove, so we continue
# Set up Linux access to the Docker repository (so it now appears in "Software 
# and updates" >> "Other software")

$ sudo apt-get install \
>     apt-transport-https \
>     ca-certificates \
>     curl \
>     gnupg-agent \
>     software-properties-common
...

$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
OK

$ sudo apt-key fingerprint 0EBFCD88 

$ sudo add-apt-repository \
>    "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
>    $(lsb_release -cs) \
>    stable"
...

$ sudo apt-get update

$ sudo apt-get install docker-ce docker-ce-cli containerd.io

$ sudo docker run hello-world
Unable to find image 'hello-world:latest' locally
latest: Pulling from library/hello-world
...
Status: Downloaded newer image for hello-world:latest

Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
    (amd64)
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.
...
{% endhighlight %}

### Reconfigure the default Docker directory

Docker images downloaded from the internet can quickly consume a lot of disk space.
You can [move the default Docker directoy on Ubuntu/Debian Linux](https://linuxconfig.org/how-to-move-docker-s-default-var-lib-docker-to-another-directory-on-ubuntu-debian-linux).

For example to move/var/lib/docker (my default) to /hdd/docker-data:

{% highlight shell %}
$ sudo vi /lib/systemd/system/docker.service

# Add -g option to this line
# ExecStart=/usr/bin/dockerd -g /hdd/docker-data -H fd://

$ ps aux | grep -i docker | grep -v grep
root      2390  0.0  0.8 1355284 66320 ?       Ssl  20:51   0:00 /usr/bin/dockerd -H fd://

$ systemctl stop docker
Warning: The unit file, source configuration file or drop-ins of docker.service changed on disk. Run 'systemctl daemon-reload' to reload units.

$ ps aux | grep -i docker | grep -v grep

$ systemctl daemon-reload

$ cd /hdd/docker-data/

$ sudo rsync -aqxP /var/lib/docker/ /hdd/docker-data

$ systemctl start docker

$ ps aux | grep -i docker | grep -v grep
root      4265  3.2  0.8 1353460 67144 ?       Ssl  21:04   0:00 /usr/bin/dockerd -g /hdd/docker-data -H fd://

$ sudo ls /hdd/docker-data
builder   containers  network	plugins   swarm  trust
buildkit  image       overlay2	runtimes  tmp	 volumes
{% endhighlight %}

### Create a Jekyll template site.

Create a [Jekyll template site in a new empty directory using Docker](https://davemateer.com/2018/01/25/Jekyll-and-Docker).
For now we'll use the default (minima) Jekyll theme.

{% highlight shell %}
# The empty directory
$ pwd
/hdd/github-projects/jekyll-test

$ ls

$ sudo docker run --rm -v=$PWD:/srv/jekyll -it jekyll/jekyll /bin/bash

bash-4.4# jekyll new .
ruby 2.6.1p33 (2019-01-30 revision 66950) [x86_64-linux-musl]
Running bundle install in /srv/jekyll... 
...

bash-4.4# exit
exit

$ ls
404.html  about.md  _config.yml  Gemfile  Gemfile.lock  index.md  _posts

$ sudo docker run --rm -v=$PWD:/srv/jekyll -p 4000:4000 -it jekyll/jekyll /bin/bash

bash-4.4# jekyll serve --force_polling 
{% endhighlight %}

View the default Jekyll theme and pages downloaded into /hdd/github-projects/jekyll-test at http://localhost:4000/

### Start Jekyll on your local machine

Start your Jekyll project on your local machine on port 4000 using Docker.

{% highlight shell %}
$ pwd
/hdd/github-projects/jekyll-test

$ sudo docker run --rm -v=$PWD:/srv/jekyll -p 4000:4000 -it jekyll/jekyll /bin/bash

# The first time you may need to install the github-pages Ruby gem
bash-4.4# gem install github-pages

bash-4.4# jekyll serve --force_polling 
{% endhighlight %}

Visit http://localhost:4000/

### Copy the Jekyll site files into your Git repository 

Copy the Jekyll files you prepared from /hdd/github-projects/jekyll-test to your Git project in /hdd/github-projects/username.github.io

{% highlight shell %}
$ pwd
/hdd/github-projects/username.github.io

$ ls
index.html  README.md

$ git branch
* master

# Create a new "develop" branch
$ git checkout -b develop
Switched to a new branch 'develop'

$ ls /hdd/github-projects/jekyll-test/
404.html  about.md  _config.yml  Gemfile  Gemfile.lock  index.md  _posts  _site

$ cp -r /hdd/github-projects/jekyll-test/* .

$ cp ../../jekyll-test/.gitignore .

$ cp -r ../../jekyll-test/.sass-cache .

$ ls 
404.html  about.md  _config.yml  Gemfile  Gemfile.lock  index.html  index.md  _posts  README.md  _site
{% endhighlight %}

### Final tweaks

{% highlight shell %}
# Added rows to the bottom of .gitignore
Gemfile.lock
*.gem

# In Gemfile
# Comment out
#gem "jekyll", "~> 3.8.5"
# Uncomment
gem "github-pages", group: :jekyll_plugins

# Add LICENSE (MIT)

# Remove index.html
{% endhighlight %}

### Start Jekyll on your local machine

{% highlight shell %}
$ pwd
/hdd/github-projects/username.github.io

$ sudo docker run --rm -v=$PWD:/srv/jekyll -p 4000:4000 -it jekyll/jekyll /bin/bash

bash-4.4# jekyll serve --force_polling 
{% endhighlight %}

Visit http://localhost:4000/

### Customise your Jekyll theme

To customise your Jekyll theme you can copy files out of the [minima Jekyll theme on GitHub](https://github.com/jekyll/minima) into your project and edit them as required.

### Publish your changes

The changes will automatically go live on your https://username.github.io site when commited and pushed to the Git "master" branch.
